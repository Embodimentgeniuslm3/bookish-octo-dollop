steps:
- checkout: self
  clean: true

- task: PkgESSetupBuild@10
  displayName: 'Package ES - Setup Build'
  inputs:
    useDfs: false
    productName: WindowsTerminal
    disableOutputRedirect: true

- task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
  displayName: 'Component Detection'

- task: DownloadBuildArtifacts@0
  displayName: Download AppX artifacts
  inputs:
    artifactName: 'appx-$(BuildConfiguration)'
    itemPattern: |
      **/*.appx
      **/*.msix
    downloadPath: '$(Build.ArtifactStagingDirectory)\appx'

- task: PowerShell@2
  displayName: 'Create $(AppxBundleName)'
  inputs:
    targetType: filePath
    filePath: '.\build\scripts\Create-AppxBundle.ps1'
    arguments: |
      -InputPath "$(Build.ArtifactStagingDirectory)\appx" -ProjectName $(AppxProjectName) -BundleVersion 0.0.0.0 -OutputPath "$(Build.ArtifactStagingDirectory)\$(AppxBundleName)"

- task: PkgESCodeSign@10
  displayName: 'Package ES - SignConfig.WindowsTerminal.xml'
  inputs:
    signConfigXml: 'build\config\SignConfig.WindowsTerminal.xml'
    inPathRoot: '$(Build.ArtifactStagingDirectory)'
    outPathRoot: '$(Build.ArtifactStagingDirectory)\signed'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Signed AppX'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\signed'
    ArtifactName: 'appxbundle-signed-$(BuildConfiguration)'
